id: io.github.grisha765.Photoshop
runtime: org.freedesktop.Platform
base: org.winehq.Wine
base-version: stable-23.08
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: photoshop.sh
finish-args: 
  - --socket=pulseaudio
  - --socket=x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  - --share=network
  - --allow=multiarch

inherit-extensions:
  - org.winehq.Wine.gecko
  - org.winehq.Wine.mono
  - org.winehq.Wine.DLLs

add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: '23.08'

modules:
  - name: photoshop
    buildsystem: simple
    build-commands:
      - install -Dm644 io.github.grisha765.Photoshop.png /app/share/icons/hicolor/scalable/apps/io.github.grisha765.Photoshop.png
      - install -Dm755 photoshop.sh /app/bin/photoshop.sh
      - install -Dm755 winetricks /app/bin/winetricks
      - install -Dm755 io.github.grisha765.Photoshop.desktop /app/share/applications/io.github.grisha765.Photoshop.desktop
      - mkdir -p /app/photoshop
      - cp -r * /app/photoshop
    sources:
      - type: script
        dest-filename: photoshop.sh
        commands:
          - export WINEPREFIX="$XDG_DATA_HOME/wine"
          - |
            if [ ! -d "$WINEPREFIX" ]; then
              echo "Init prefix..."
              wineboot
              /app/bin/winetricks win11
              /app/bin/winetricks fontsmooth=rgb gdiplus msxml3 msxml6 atmlib corefonts dxvk win11 vkd3d
              /app/bin/winetricks -q vcrun2013 vcrun2015 vcrun2017 vcrun2019
              winecfg -v win11
            else
              echo "The prefix is already initialized, skip the initialization step."
            fi
          - STATE_FILE=$WINEPREFIX/.wine_virtual_desktop_state
          - |
            if [ -f $STATE_FILE ]; then
                CURRENT_STATE=$(cat $STATE_FILE)
            else
                CURRENT_STATE=0
            fi
          - |
            if [ -z $DESKTOP_SIZE ]; then
                if [ $CURRENT_STATE = "0" ]; then
                    echo "Virtual desktop is already disabled. No changes needed."
                else
                    echo "Disabling virtual desktop..."
                    /app/bin/winetricks vd=off
                    echo 0 > "$STATE_FILE"
                fi
            else
                if [ $CURRENT_STATE = $DESKTOP_SIZE ]; then
                    echo "Virtual desktop is already set to $DESKTOP_SIZE. No changes needed."
                else
                    echo "Setting virtual desktop to $DESKTOP_SIZE..."
                    /app/bin/winetricks vd=$DESKTOP_SIZE
                    echo $DESKTOP_SIZE > $STATE_FILE
                fi
            fi
          - FILE_PATH=$(winepath -w "$1")
          - DXVK_LOG_PATH=$WINEPREFIX DXVK_STATE_CACHE_PATH=$WINEPREFIX wine64 /app/photoshop/photoshop.exe $FILE_PATH
      - type: archive
        url: https://github.com/jolygmanka/filehost/releases/download/addfile1/linux_editor.tar.xz
        sha256: 8321b969161f2d2ad736067320d493c5b6ae579eaab9400cd1fda6871af2c033
      - type: file
        url: https://raw.githubusercontent.com/Winetricks/winetricks/72b934e1e10c041ec6986f5f2fb4f143d8f6b941/src/winetricks
        sha256: f0edc844169086d7070cc642ab2ed8360d09ce7b2d51739caf0336dee5177d6c
      - type: file
        path: io.github.grisha765.Photoshop.desktop
      - type: file
        path: io.github.grisha765.Photoshop.png
